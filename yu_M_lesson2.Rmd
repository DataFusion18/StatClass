---
title: "心理学統計法演習2日目"
---

# 準備

## 環境清掃
```{r}
rm(list = ls())
```

## パッケージの装備 
```{r libraries on}
# データ整形汎用パッケージ
library(tidyverse)
# MCMC乱数発生器stanをRからつかうパッケージ
library(rstan)
# rstanを並列で使うオプション
options(mc.cores = parallel::detectCores())
# 変更なしの実行ファイルは保存しておくオプション
rstan_options(auto_write = TRUE)
# データ要約・可視化パッケージ
library(summarytools)
library(plotly)
# 複数のグラフを並べて表示するパッケージ
library(gridExtra)
library(GGally)
# ベイズモデル比較指標計算パッケージ
library(loo)
# ベイズモデルの結果を可視化するパッケージ
library(bayesplot)
# 描画の際に文字化けするMacユーザは次の行のコメントアウトをとって実行する
old = theme_set(theme_gray(base_family = "HiraKakuProN-W3"))
```

## サンプルデータの準備
```{r datasets}
bs <- read_csv("baseball.csv") %>% mutate(Name = as.factor(Name), 
                                          team = as.factor(team), 
                                          position = as.factor(position), 
                                          bloodType = as.factor(bloodType), 
                                          throw.by = as.factor(throw.by), 
                                          batting.by = as.factor(batting.by))
view(dfSummary(bs))
# 可視化
bs %>% filter(position != "投手") %>% 
  dplyr::select(salary,years, height, weight) %>% ggpairs()

bs %>% filter(position == "投手") %>% 
  dplyr::select(salary,years, height, weight) %>% ggpairs()
```

# 一変量の推定
## 平均値を例に

### データ整形
```{r data prepare1}
height <- bs %>% select(height) %>% na.omit() %>% unlist()
```

### モデルコンパイル
```{r stan1,results="hide"}
model01 <- stan_model("01_normal.stan")
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("01_normal.stan"), collapse = "\n") %>% cat()
```

### 推定開始
```{r}
dataset1 <- list(N = NROW(height), X = height)
fit01 <- sampling(model01, data = dataset1, 
                  warmup = 1000, iter = 2000, chains = 4)
```

### 結果の確認
```{r}
fit01
```

### MCMCサンプルの取り出し
```{r}
fit01.mcmc <- rstan::extract(fit01, pars = c("mu", "sig")) %>% 
  as.data.frame()
# サンプルの長さを確認
NROW(fit01.mcmc)
```

```{r}
# 事後分布
fit01.mcmc %>% ggplot(aes(x = mu)) + geom_histogram(binwidth = 0.01)
fit01.mcmc %>% ggplot(aes(x = sig)) + geom_histogram(binwidth = 0.01)
```


### 同時分布であることをしっかり意識して
```{r}
gg <- fit01.mcmc %>% ggplot(aes(x = mu, y = sig)) + geom_point()
ggplotly(gg)
x_c <- fit01.mcmc$mu %>% cut(., 50)
y_c <- fit01.mcmc$sig %>% cut(., 50)
z <- table(x_c, y_c)
plot_ly(z=z,type='surface')
```


## 本当は事前分布を入れたほうがいい
```{r,results="hide"}
model02 <- stan_model("02_normal.stan")
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("02_normal.stan"), collapse = "\n") %>% cat()
```
```{r}
fit02 <- sampling(model02, data = dataset1,
                  warmup = 1000, iter = 2000, 
                  chains = 4)
```

### 結果の確認
```{r}
fit02
```

### MCMCサンプルの取り出し
```{r}
fit02.mcmc <- rstan::extract(fit02, pars = c("mu", "sig")) %>% 
  as.data.frame()
# サンプルの長さを確認
NROW(fit02.mcmc)
```

### 事後分布
```{r}
fit02.mcmc %>% ggplot(aes(x = mu)) + geom_histogram(binwidth = 0.01)
fit02.mcmc %>% ggplot(aes(x = sig)) + geom_histogram(binwidth = 0.01)
```

### 同時分布
```{r}
gg <- fit02.mcmc %>% ggplot(aes(x = mu, y = sig)) + geom_point()
ggplotly(gg)
x_c <- fit02.mcmc$mu %>% cut(., 50)
y_c <- fit02.mcmc$sig %>% cut(., 50)
z <- table(x_c, y_c)
plot_ly(z=z,type='surface')
```


## 事前予測分布と事後予測分布
```{r}
weight <- bs %>% select(weight) %>% na.omit() %>% unlist()
dataset2 <- list(N = NROW(weight), X = weight)
```

```{r,results="hide"}
model03 <- stan_model("03_normal.stan")
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("03_normal.stan"), collapse = "\n") %>% cat()
```
```{r}
fit03 <- sampling(model03, data = dataset2,
                  warmup = 2000, iter = 5000, 
                  chains = 4)
# 結果の確認
fit03
```

## 描画して確認
```{r}
fit03.mcmc <- rstan::extract(fit03, pars = c("mu", "sig", "mu_pre", 
  "sig_pre", "pred1", "pred2")) %>% as.data.frame()
```

## 四つの分布を描画する
```{r}
### 事前分布
g1 <- fit03.mcmc %>% select(mu_pre, sig_pre) %>% gather(key, 
  val, factor_key = T) %>% ggplot(aes(x = val, color = key, 
  fill = key)) + geom_histogram(binwidth=5) + facet_wrap(~key, scales = "free")
### 事前予測分布
g2 <- fit03.mcmc %>% select(pred1) %>% ggplot(aes(x = pred1)) + 
  geom_histogram(binwidth=5)
### 事後分布
g3 <- fit03.mcmc %>% select(mu, sig) %>% gather(key, val, factor_key = T) %>% 
  ggplot(aes(x = val, color = key, fill = key)) + geom_histogram(binwidth=5) + 
  facet_wrap(~key, scales = "free")
### 事後予測分布
g4 <- fit03.mcmc %>% select(pred2) %>% ggplot(aes(x = pred2)) + 
  geom_histogram(binwidth=5)


# 個別表示
g1
g2
g3
g4
# まとめて表示
grid.arrange(g1, g2, g3, g4, ncol = 2)
```

# 平均年俸ー分布が違う場合の平均値の推定
```{r}
bs %>% select(salary) %>% 
  ggplot(aes(x = salary)) + geom_histogram(binwidth = 1000)
sal <- bs %>% select(salary) %>% na.omit() %>% unlist()
# 事前分布に上限と下限を入れる
dataset3 <- list(N = NROW(sal), X = sal, Lower = 0, Upper = 10000000)
```
```{r,results="hide"}
model04 <- stan_model("04_normal.stan")
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("04_normal.stan"), collapse = "\n") %>% cat()
```
```{r}
fit04 <- sampling(model04, dataset3)
fit04
```

## 描画して確認
```{r}
fit04.mcmc <- rstan::extract(fit04, pars = c("mu", "sig", "mu_pre", 
  "sig_pre", "pred1", "pred2")) %>% as.data.frame()
### 事前分布
g1 <- fit04.mcmc %>% select(mu_pre, sig_pre) %>% gather(key, 
  val, factor_key = T) %>% ggplot(aes(x = val, color = key, 
  fill = key)) + geom_histogram() + facet_wrap(~key, scales = "free")
### 事前予測分布
g2 <- fit04.mcmc %>% select(pred1) %>% ggplot(aes(x = pred1)) + 
  geom_histogram()
### 事後分布
g3 <- fit04.mcmc %>% select(mu, sig) %>% gather(key, val, factor_key = T) %>% 
  ggplot(aes(x = val, color = key, fill = key)) + geom_histogram() + 
  facet_wrap(~key, scales = "free")
### 事後予測分布
g4 <- fit04.mcmc %>% select(pred2) %>% ggplot(aes(x = pred2)) + 
  geom_histogram()
# 個別表示
g1
g2
g3
g4
# まとめて表示
grid.arrange(g1, g2, g3, g4, ncol = 2)
```


## 対数正規分布モデルに変える
```{r,results='hide'}
model05 <- stan_model("05_lognormal.stan")
bs %>% select(salary) %>% 
  ggplot(aes(x = salary)) + geom_histogram(binwidth = 1000)
sal <- bs %>% select(salary) %>% na.omit() %>% unlist()
# 事前分布に上限と下限を入れる
dataset4 <- list(N = NROW(sal), X = sal)
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("05_lognormal.stan"), collapse = "\n") %>% cat()
```
```{r}
fit05 <- sampling(model05, dataset4)
fit05.mcmc <- rstan::extract(fit05, pars = c("mu", "sig", "pred1")) %>% 
  data.frame()
g1 <- fit05.mcmc %>% ggplot(aes(x = pred1)) + 
  geom_histogram(binwidth = 1000) + 
  xlim(0, 50000) + xlab("事後予測分布")

g2 <- bs %>% select(salary) %>% ggplot(aes(x = salary)) + geom_histogram(binwidth = 1000) + 
  xlim(0, 50000) + xlab("データ分布")
grid.arrange(g2, g1, ncol = 2)
```

### 数字で見ておく
```{r}
summary(bs$salary)
summary(fit05.mcmc$pred1)
# 対数正規分布の平均値
fit05
fit05.mcmc$mu %>% exp %>% mean
```


適当な確率分布でなければならないことがわかったところで

# 打率の推定
```{r}
df <- bs %>% filter(position != "投手" & 打数 > 3) %>% select(打数, 安打, 打率) %>% na.omit()
df %>% ggplot(aes(x = 打率)) + geom_histogram(binwidth = 0.01)
dataset5 <- list(L = NROW(df), N = df$打数, X = df$安打)
```
```{r,results='hide'}
model06 <- stan_model("06_binomial.stan")
```

```{r, echo=FALSE, eval=TRUE}
paste(readLines("06_binomial.stan"), collapse = "\n") %>% cat()
```

```{r}
fit06 <- sampling(model06, dataset5)
fit06
rstan::extract(fit06,pars="pred") %>% as.data.frame() %>% 
  tidyr::gather(key,val) %>% group_by(key) %>% print() %>%
  summarize(med=median(val)) %>%
  ggplot(aes(x=med))+geom_histogram()

rstan::extract(fit06,pars='theta') %>% as.data.frame() %>%
  ggplot(aes(x=theta))+geom_histogram()
summary(df$打率)
```


# 二つの変数と平均の差の検定

## 身長と体重の相関
```{r}
df <- bs %>% select("height", "weight") %>% na.omit()
df %>% ggplot(aes(x = height, y = weight)) + geom_point()
cor(df)
dataset6 <- list(L = NROW(df), X = df)
```

```{r,results='hide'}
model07 <- stan_model("07_corr.stan")
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("07_corr.stan"), collapse = "\n") %>% cat()
```
```{r}
fit07 <- sampling(model07, dataset6)
fit07
```


## 二変数の推定 セリーグとパリーグの体格差
### データの準備
```{r}
Cleague <- c("Carp", "DeNA", "Dragons", "Giants", "Swallows", 
  "Tigers")
df <- bs %>% mutate(league = factor(ifelse(team %in% Cleague, 
  1, 2), labels = c("C", "P"))) %>% select("weight", "league") %>% 
  na.omit()
df %>% ggplot(aes(x = weight, group = league, fill = league)) + 
  geom_histogram(binwidth = 2, alpha = 0.5)
```

### いわゆるt検定
```{r}
var.test(weight ~ league, data = df)
t.test(weight ~ league, data = df, var.equal=T)
```

### ベイズ的alternative
```{r,results='hide'}
model08 <- stan_model("08_ttest.stan")
```

```{r, echo=FALSE, eval=TRUE}
paste(readLines("08_ttest.stan"), collapse = "\n") %>% cat()
```

```{r}
dataset7 <- list(N1 = NROW(df[df$league == "C", ]), 
                N2 = NROW(df[df$league == "P", ]),
                X1 = unlist(df[df$league == "C", "weight"]),
                X2 = unlist(df[df$league == "P", "weight"]))
fit08 <- sampling(model08, dataset7)
fit08
```
```{r}
plot(fit08, pars = c("mu1", "mu2"), show_density = TRUE)
```

### 可視化
```{r}
rstan::extract(fit08, pars = c("mu1", "mu2")) %>% data.frame %>% 
  gather(key, val, factor_key = TRUE) %>% ggplot(aes(x = val, 
  group = key, fill = key)) + geom_histogram(binwidth = 0.01, 
  alpha = 0.5)
```


### 差の分布
```{r,results='hide'}
model09 <- stan_model("09_ttest.stan")
```

```{r, echo=FALSE, eval=TRUE}
paste(readLines("09_ttest.stan"), collapse = "\n") %>% cat()
```

```{r}
fit09 <- sampling(model09, dataset7)
fit09
rstan::extract(fit09, pars = "d") %>% data.frame() %>% 
  ggplot(aes(x = d)) + geom_density()

```


### 様々な仮説を検討することができる
```{r}
df <- rstan::extract(fit09, pars = "d") %>% data.frame

NROW(df[df$d > 0, ])/NROW(df)
NROW(df[(df$d > -2) & (df$d < (-1)), ])/NROW(df)
```


## 分布が違っても良い。セリーグとパリーグの年俸差
### データの準備
```{r}
df <- bs %>% mutate(league = factor(ifelse(team %in% Cleague, 
  1, 2), labels = c("C", "P"))) %>% select("salary", "league") %>% 
  na.omit()
```

```{r,results='hide'}
model10 <- stan_model("10_log_ttest.stan")
```

```{r, echo=FALSE, eval=TRUE}
paste(readLines("10_log_ttest.stan"), collapse = "\n") %>% cat()
```

```{r}
dataset <- list(N1 = NROW(df[df$league == "C", ]),
                N2 = NROW(df[df$league == "P", ]),
                X1 = unlist(df[df$league == "C", "salary"]),
                X2 = unlist(df[df$league == "P", "salary"]))

fit10 <- sampling(model10, dataset)
fit10
```


## 多群の比較
```{r}
df <- bs %>% select("team", "salary") %>% na.omit()
df %>% ggplot(aes(x = team, y = salary, group = team, fill = team)) + 
  stat_summary(fun.y = mean, geom = "bar") + coord_flip()
dataset <- list(L = NROW(df), G = max(as.numeric(df$team)), 
                team = as.integer(df$team),X = df$salary)
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("11_log_mean.stan"), collapse = "\n") %>% cat()
```
```{r}
model11 <- stan_model("11_log_mean.stan")
fit11 <- sampling(model11, dataset)
print(fit11)
```

# 回帰分析

## 相関のあるデータ
```{r}
bs %>% dplyr::select("weight", "height") %>% 
  ggplot(aes(x = weight, y = height)) + geom_point()

```
### データを作って
```{r}
df <- bs %>% dplyr::select("weight", "height") %>% na.omit
```

### いわゆる普通の回帰分析
```{r}
summary(lm(height ~ weight, data = df))
```

### ベイジアン回帰分析
```{r}
dataset <- list(L = NROW(df), X = df$weight, Y = df$height)
```
```{r,results='hide'}
model12 <- stan_model("12_regression.stan")
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("12_regression.stan"), collapse = "\n") %>% cat()
```

```{r}
fit12 <- sampling(model12, dataset)
```
```{r}
print(fit12, pars = c("beta_0", "beta_1", "sigma"))
plot(fit12,pars=c("sigma"),show_density=T)
bayesplot::mcmc_dens(as.array(fit12), pars = c("beta_0", "beta_1", "sigma"))
```

## 事後予測分布
```{r}
pred <- rstan::extract(fit12, pars = "pred") %>% 
  data.frame() %>% 
  tidyr::gather(key, val, factor_key = T) %>% 
  dplyr::group_by(key) %>% 
  dplyr::summarize(EAP = mean(val))

data.frame(weight = df$weight, height = df$height, pred = pred$EAP) %>% 
  tidyr::gather(key, val, -weight, factor_key = T) %>% 
  ggplot(aes(x = weight, y = val, color = key)) + geom_point()

```

## R2や適合度も計算してみよう
```{r}
(cor(df$height, pred$EAP))^2
rstan::extract(fit12, pars = "log_lik")$log_lik %>% loo()
```



# 一般化線形モデル

## ピッチャーの勝利！ 1勝はしてる人で
```{r}
df <- bs %>% filter(position == "投手" & 勝利 > 0) %>% dplyr::select("勝利", 
  "salary") %>% na.omit() %>% mutate(salary.z = as.numeric(scale(salary)))
df %>% ggplot(aes(x = 勝利)) + geom_histogram(binwidth = 1)
table(df$勝利)
```

```{r}
df %>% ggplot(aes(y = 勝利, x = salary.z)) + geom_point() + 
  geom_smooth(method = "lm", se = F)
```

## 普通の回帰分析だとダメ
```{r}
result.lm <- lm(勝利 ~ salary.z, data = df)
hist(result.lm$residuals)
plot(result.lm)
```



## ベイズの事後予測分布でも
```{r}
dataset <- list(L = NROW(df), X = df$salary.z, Y = df$勝利)
fit12 <- sampling(model12, dataset)
pred <- rstan::extract(fit12, pars = "pred") %>% data.frame() %>% 
  tidyr::gather(key, val, factor_key = T) %>% dplyr::group_by(key) %>% 
  dplyr::summarize(EAP = mean(val))
data.frame(win = df$勝利, pred = pred$EAP) %>% tidyr::gather(key, 
  val, factor_key = T) %>% ggplot(aes(x = val, fill = key)) + 
  geom_histogram(binwidth = 0.1)
```

## ポアソン回帰にしてみよう
```{r}
dataset <- list(L = NROW(df), X = df$salary.z, Y = df$勝利)
```
```{r,results='hide'}
model13 <- stan_model("13_pois_reg.stan")
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("13_pois_reg.stan"), collapse = "\n") %>% cat()
```
```{r}
fit13 <- sampling(model13, dataset)
print(fit13, pars = c("beta_0", "beta_1"))
```

## ポアソン回帰専用の関数もある
```{r,results='hide'}
model14 <- stan_model("14_poislog_reg.stan")
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("14_poislog_reg.stan"), collapse = "\n") %>% cat()
```

```{r}
fit14 <- sampling(model14, dataset)
print(fit14, pars = c("beta_0", "beta_1"))
```
### 結果の可視化
```{r}
rstan::extract(fit14, pars = "pred") %>% 
  data.frame() %>% 
  tidyr::gather(key, val, factor_key = T) %>% 
  group_by(key) %>% 
  summarize(median = median(val)) %>% 
  cbind(., df$勝利) %>% 
  gather(key2, val, -key, factor_key = T) %>% 
  ggplot(aes(x = val, fill = key2)) + 
  geom_histogram(binwidth = 0.1, alpha = 0.6) + 
  facet_wrap(~key2)
```


## 負の二項分布を試してみる
```{r,results='hide'}
model15 <- stan_model("15_nb.stan")
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("15_nb.stan"), collapse = "\n") %>% cat()
```
```{r}
fit15 <- sampling(model15, dataset)
print(fit15, pars = c("beta_0", "beta_1", "phi"))
```


## 専用の関数も
```{r,results='hide'}
model16 <- stan_model("16_nb2.stan")
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("16_nb2.stan"), collapse = "\n") %>% cat()
```
```{r}
fit16 <- sampling(model16, dataset)
print(fit16, pars = c("beta_0", "beta_1", "phi"))
```
### 結果の可視化

```{r}
rstan::extract(fit16, pars = "pred") %>% 
  data.frame() %>% 
  tidyr::gather(key,val, factor_key = T) %>% 
  group_by(key) %>% 
  summarize(median = median(val)) %>% 
  cbind(., df$勝利) %>% 
  gather(key2, val, -key, factor_key = T) %>% 
  ggplot(aes(x = val, fill = key2)) + 
  geom_histogram(binwidth = 0.1, alpha = 0.6) + facet_wrap(~key2)
```


# 階層線形モデル

## チームごとの階層を考えよう
```{r}
bs %>% filter(position != "投手") %>% 
  select("salary", "本塁打", "team") %>% 
  na.omit() %>% 
  ggplot(aes(x = 本塁打, y = salary, color = team)) + 
  geom_point() + geom_smooth(method = "lm", se = F)
```

## データセットを作ります
```{r}
df <- bs %>% filter(position != "投手") %>%
  select("salary","本塁打", "team") %>% na.omit() %>%
  mutate(salary.z = as.numeric(scale(salary)))
```


## 普通の回帰分析をやってみる
```{r}
dataset <- list(L = NROW(df), X = df$本塁打, Y = df$salary)
model12 <- stan_model("12_regression.stan")
fit12 <- sampling(model12, dataset)
print(fit12, pars = c("beta_0", "beta_1", "sigma"))
```

## チームによって傾きは違う，というのを考慮する
```{r}
dataset <- list(L=NROW(df),X=df$本塁打, Y=df$salary,
                G=12, Idx=as.numeric(df$team))
```
```{r,results='hide'}
model17 <- stan_model('17_HLM.stan')
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("17_HLM.stan"), collapse = "\n") %>% cat()
```
```{r}
fit17 <- sampling(model17,dataset)
print(fit17,pars=c("beta_0","beta_1"))
```
### 可視化
```{r}
rstan::extract(fit17,pars='pred') %>% data.frame() %>% 
  tidyr::gather(key,val,factor_key=T) %>% 
  group_by(key) %>% 
  summarize(EAP=mean(val)) %>% 
  cbind(.,df) %>% select('EAP','salary','team') %>% 
  ggplot(aes(x=salary,y=EAP,color=team))+geom_point()+
  facet_wrap(~team)
```


## 階層化ー個別の推定を超えて
```{r,results='hide'}
model18 <- stan_model('18_HLM.stan')
```
```{r, echo=FALSE, eval=TRUE}
paste(readLines("18_HLM.stan"), collapse = "\n") %>% cat()
```
```{r}
fit18 <- sampling(model18,dataset)
print(fit18,pars=c("beta_0","mu_beta1","tau"))
rstan::extract(fit18,pars='pred') %>% data.frame() %>% 
  tidyr::gather(key,val,factor_key=T) %>% 
  group_by(key) %>% 
  summarize(EAP=mean(val)) %>% 
  cbind(.,df) %>% select('EAP','salary','team') %>% 
  ggplot(aes(x=salary,y=EAP,color=team))+geom_point()+
  facet_wrap(~team)
```

